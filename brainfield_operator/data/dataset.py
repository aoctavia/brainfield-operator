# brainfield_operator/data/dataset.py

from __future__ import annotations
import os
import glob
import numpy as np
import torch
from torch.utils.data import Dataset


class BrainFieldDataset(Dataset):
    """
    Simple Dataset that loads .npz files generated by generate_dataset.

    Each .npz is expected to contain:
        - sigma
        - electrode_potential
        - V
        (optional: Ex, Ey)

    The model input will be:
        x = stack([sigma, electrode_potential], axis=0)  # [2, H, W]
    Target:
        y = V[None, ...]                                 # [1, H, W]
    """

    def __init__(
        self,
        root_dir: str,
        pattern: str = "sample_*.npz",
        transform=None,
        max_samples: int | None = None,
    ):
        self.root_dir = root_dir
        self.files = sorted(glob.glob(os.path.join(root_dir, pattern)))
        if max_samples is not None:
            self.files = self.files[:max_samples]
        if len(self.files) == 0:
            raise RuntimeError(f"No .npz files found in {root_dir} with pattern {pattern}")
        self.transform = transform

    def __len__(self):
        return len(self.files)

    def __getitem__(self, idx: int):
        path = self.files[idx]
        data = np.load(path)

        sigma = data["sigma"]  # (H, W)
        elec = data["electrode_potential"]
        V = data["V"]

        x = np.stack([sigma, elec], axis=0)  # [2, H, W]
        y = np.expand_dims(V, axis=0)        # [1, H, W]

        x = torch.from_numpy(x)
        y = torch.from_numpy(y)

        if self.transform is not None:
            x, y = self.transform(x, y)

        return x.float(), y.float()
